<!DOCTYPE html>
<html>

<head>
    <title>Yahoo Pipes: Top 10 news!</title>
    <script data-require="jquery@*" data-semver="2.1.4" src="http://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="http://ajax.aspnetcdn.com/ajax/jquery.templates/beta1/jquery.tmpl.min.js"></script>
    <link href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css" rel="stylesheet"
          data-semver="3.3.1" data-require="bootstrap-css@*"/>
    <style>
        .thumbnail {
            max-width: 128px;
            max-height: 100%;
        }

        .vcenter {
            display: inline-block;
            vertical-align: middle;
            float: none;
        }

        .table-cell {
            padding: 0px 10px;
        }

        .bg-cover {
            background-size: cover;
            background-repeat: no-repeat;
        }
    </style>
</head>

<body class="container">
<div id="content-container">
    <header>
        <h1 class="well text-center" id="page-motto"></h1>
    </header>
    <section id="jumbo" class="jumbotron" style="display: none">
        <div class="content" id="data-host"></div>
    </section>
</div>
<script>
    var pipesUrl = 'http://pipes.yahoo.com/pipes/pipe.run?_id=e9a2e77dffb3205d035c4e311d77bbe6&_render=json';
    var templateUrl = 'Templates/NewsPostTemplate.html';
    var pageMotto = $('#page-motto');
    var newsContainer = $('#data-host');

    var renderNewsOnPage = function (data) {
        if (data.count == 0) {
            pageMotto.text('Sorry, but server returned no news for now. Try again later.');
        } else {
            $('#jumbo').fadeIn('slow');
            newsContainer.append(composeNews(data));
            pageMotto.text('Top ' + data.count + ' news from "' + data.value.title + '" pipe!');

            newsContainer.delegate(".news-title", "click", this, toggleDescription);
        }
    };

    var composeNews = function (pipeData) {
        var divsHost = $(document.createElement('div'));
        return $.tmpl("cachedNewsPostTemplate", pipeData.value.items).appendTo(divsHost);
    };

    var reportError = function () {
        pageMotto.text('Sorry, but server returned an error.');
    };

    var toggleDescription = function (titleElement) {
        var description = $(titleElement.currentTarget.parentNode).find('.post-details');

        if (description.css('display') == 'none')
            description.fadeIn('slow');
        else
            description.fadeOut('slow');
    };

    var getData = function(requestUrl){
        return $.get(requestUrl);
    };

    var getTemplate = function(){
        return getData(templateUrl)
                .then(cacheTemplate, reportError);
    };

    var loadPipesData = function(){
        return getData(pipesUrl)
                .fail(reportError);
    };

    var cacheTemplate = function(data){
        $.template("cachedNewsPostTemplate", data)
    };

    $(getTemplate()
        .then(loadPipesData)
        .then(renderNewsOnPage)
    );
</script>
</body>
</html>