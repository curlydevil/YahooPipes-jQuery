<!DOCTYPE html>
<html>

<head>
    <title>Yahoo Pipes: Top 10 news!</title>
    <script data-require="jquery@*" data-semver="2.1.4" src="http://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="http://ajax.aspnetcdn.com/ajax/jquery.templates/beta1/jquery.tmpl.min.js"></script>
    <link href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css" rel="stylesheet" data-semver="3.3.1" data-require="bootstrap-css@*" />
    <style>
        .thumbnail {
            max-width: 128px;
            max-height: 100%;
        }

        .vcenter {
            display: inline-block;
            vertical-align: middle;
            float: none;
        }

        .table-cell {
            padding: 0px 10px;
        }

        .bg-cover {
            background-size: cover;
            background-repeat: no-repeat;
        }
    </style>
</head>

<body class="container">
<div id="content-container">
    <header>
        <h1 class="well text-center" id="page-motto"></h1>
    </header>
    <section id="jumbo" class="jumbotron" style="display: none">
        <div class="content" id="data-host"></div>
    </section>
</div>
<script>
    const requestUrl = 'http://pipes.yahoo.com/pipes/pipe.run?_id=e9a2e77dffb3205d035c4e311d77bbe6&_render=json';
    var pageMotto = $('#page-motto');

    var htmlPipeTemplate;
    (function(){
        htmlPipeTemplate = '<div style="background-image:url(${ImageSrc})" class="well table-row bg-cover">';
        htmlPipeTemplate += '<div class="vcenter table-cell">';
        htmlPipeTemplate += '<a class="thumbnail" href="${ImageSrc}" target="_blank">';
        htmlPipeTemplate += '<img src="${ImageSrc}" title="Click to open full size image in new window">';
        htmlPipeTemplate += '</a>';
        htmlPipeTemplate += '<a onclick="show(${Id})">';
        htmlPipeTemplate += '<p class="vcenter table-cell well">${Title}</p></a>';
        htmlPipeTemplate += '<p id="${Id}" class="vcenter table-cell well" style="display: none">${Description}';
        htmlPipeTemplate += '<br/><a href="${Url}" target="_blank">More info</a></p>';
        htmlPipeTemplate += '</div></div>';
    })();

    var renderNewsOnPage = function(data) {
        if(data.count == 0){
            pageMotto.text('Sorry, but server returned no news for now. Try again later.');
        } else {
            $('#jumbo').fadeIn('slow');
            $('#data-host').append(parsePipesResponse(data));
            pageMotto.text('Top ' + data.count + ' news from "' + data.value.title + '" pipe!');
        }
    };

    var composePipeElement = function(pipeData) {
        return $.tmpl(htmlPipeTemplate, pipeData);
    };

    var parsePipesResponse = function(data) {
        var divsHost = $(document.createElement('div'));

        for (var i = 0; i < data.count; i++) {
            var imageUrl = data.value.items[i].enclosure.url;
            var title = data.value.items[i].title;
            var link = data.value.items[i].link;
            var description = data.value.items[i].description;
            composePipeElement({
                Id:i,
                ImageSrc : imageUrl,
                Title : title,
                Url:link,
                Description:description})
                    .appendTo(divsHost);
        }
        return divsHost;
    };

    var reportError = function(){
        pageMotto.text('Sorry, but server returned an error.');
    };

    var show = function(id) {
        var element = $('#'+id);
        if(element.css('display') == 'none')
            element.fadeIn('slow');
        else
            element.fadeOut('slow');
    };

    $(function(){
                $.get(requestUrl)
                        .done(renderNewsOnPage)
                        .fail(reportError)}
    );
</script>
</body>
</html>
